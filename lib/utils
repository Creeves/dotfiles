#!/bin/bash

# The directory in which to store the backups of our files
DOTFILES_BACKUP_DIRECTORY="backups"

# This is the location in which we will be linking our files
TARGET_LINK_DIR=$HOME

# If we are in a vagrant instance, we will manually override that link here
if [ -d /home/vagrant ]; then
    TARGET_LINK_DIR="/home/vagrant"
fi

backup_prev() {

    # Define our directories to work with
    TIMESTAMP_DIRECTORY="$(date +%Y-%m-%d_%H-%M-%S)"
    BACKUP_DIRECTORY="$DOTFILES_DIRECTORY/${DOTFILES_BACKUP_DIRECTORY}/${TIMESTAMP_DIRECTORY}"

    # If the user is spamming this button more than once per second,
    # we should just bail now.
    if [ -d ${BACKUP_DIRECTORY} ]; then
        exit
    fi

    # Create the timestamped backup directory
    mkdir ${BACKUP_DIRECTORY}

    # Define an array of items to backup

    declare -a items_to_backup=(
        .gitattributes
        .gitconfig
        .gitignore_global
        .fonts
        .curlrc
        .bash_profile
        .bashrc
        .inputrc
        .profile
        .minttyrc
        .vim
        .vimrc
    )

    # Move all the matching items
    for item in "${items_to_backup[@]}"
    do
        mv $HOME/$item ${BACKUP_DIRECTORY}/$item 2> /dev/null
    done;

    # If the directory is empty, we can just delete it because
    # nothing was backed up
    if [ ! "$(\ls -A ${BACKUP_DIRECTORY})" ]; then
        rm -rf ${BACKUP_DIRECTORY}
    fi
}

# Force create/replace symbolic symlink.
link() {
    ln -fs "${1}" "${2}"
}

#
link_files() {

    backup_prev $1

    link "${1}/git/gitattributes"     "${TARGET_LINK_DIR}/.gitattributes"
    link "${1}/git/gitignore_global"  "${TARGET_LINK_DIR}/.gitignore_global"
    link "${1}/shell/fonts/"          "${TARGET_LINK_DIR}/.fonts"
    link "${1}/shell/curlrc"          "${TARGET_LINK_DIR}/.curlrc"
    link "${1}/shell/bashrc"          "${TARGET_LINK_DIR}/.bashrc"
    link "${1}/shell/bash_profile"    "${TARGET_LINK_DIR}/.bash_profile"
    link "${1}/shell/inputrc"         "${TARGET_LINK_DIR}/.inputrc"
    link "${1}/shell/profile"         "${TARGET_LINK_DIR}/.profile"
    link "${1}/shell/minttyrc"        "${TARGET_LINK_DIR}/.minttyrc"
    link "${1}/vim/"                  "${TARGET_LINK_DIR}/.vim"
    link "${1}/vim/vimrc"             "${TARGET_LINK_DIR}/.vimrc"

    if [ $(os) == "CYGWIN" ]; then
        if [ ! -L "/usr/local/bin/subl" ]; then
            link "${1}/bin/cygwin/subl"   "/usr/local/bin/subl"
        fi
    fi

    cp   "${1}/git/gitconfig"         "${HOME}/.gitconfig"

}

# vim: set syn=sh :
